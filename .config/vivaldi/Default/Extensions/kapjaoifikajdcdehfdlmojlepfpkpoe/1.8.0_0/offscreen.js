"use strict";(()=>{var Sr=Object.defineProperty;var Rr=(t,r,e)=>r in t?Sr(t,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[r]=e;var V=(t,r,e)=>(Rr(t,typeof r!="symbol"?r+"":r,e),e);var u=[];var G=globalThis.browser??globalThis.chrome;var Or=function(t,r,e,n,o){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!o)throw new TypeError("Private accessor was defined without a setter");if(typeof r=="function"?t!==r||!o:!r.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?o.call(t,e):o?o.value=e:r.set(t,e),e},Fr=function(t,r,e,n){if(e==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof r=="function"?t!==r||!n:!r.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e==="m"?n:e==="a"?n.call(t):n?n.value:r.get(t)},ae,E=class extends Error{constructor(r,e){super(e),ae.set(this,void 0),Or(this,ae,r,"f")}get key(){return Fr(this,ae,"f")}};ae=new WeakMap;function F(t,r,e){return(n,o="")=>{try{let s=r.reduce((a,S)=>S(a,o),n);return e?.(s,o),Pr(o,t,s)}catch(s){return Ae(n,s)}}}function Ae(t,r){return{initialValue:t,hasError:!0,error:r}}function Pr(t,r,e){try{return r.forEach(n=>n(e,t)),{initialValue:e,result:e,hasError:!1}}catch(n){return Ae(e,n)}}var N=(t,r,e,n)=>(o,s="")=>{if(!(t?!r(o):r(o)))throw new E(s,`${e??typeof o} '${o}' ${t?"is":"is not"} ${n}`)};function Ar(t,r,e,n){return`${t} ${r} is${n?" ":" not "}${e}`}function Y(t){return(r,e,n,o,s)=>{if(!e())throw new E(r,Ar(t,n,o,s))}}var ie=Y("array"),Ue=t=>r=>(e,n="")=>{ie(n,()=>t?e.length!==r:e.length===r,`of length ${e.length}`,`of exact length ${r}`,t)},Ur=t=>r=>(e,n="")=>{ie(n,()=>t?e.length<r:e.length>=r,`of length ${e.length}`,`within minimum length of ${r}`,t)},Ir=t=>r=>(e,n="")=>{ie(n,()=>t?e.length>r:e.length<=r,`of length ${e.length}`,`within maximum length of ${r}`,t)},Ie=t=>()=>(r,e="")=>{ie(e,()=>t?r.length!==0:r.length===0,`of length ${r.length}`,"empty",t)};function te(t=[]){let r=[],e=F(r,t,(n,o="")=>{if(!Array.isArray(n))throw new E(o,`Value ${n} is not an array`)});return e.toString=P(e,n=>n.join(", ")),e.toNumber=A(e,n=>Number(n)),e.toBoolean=U(e,n=>!!n),e.toCustom=_(e),e.assert=(n,o)=>(r.push(N(!1,n,"array",o)),e),e.ofExactLength=n=>(r.push(Ue(!1)(n)),e),e.ofMinLength=n=>(r.push(Ur(!1)(n)),e),e.ofMaxLength=n=>(r.push(Ir(!1)(n)),e),e.empty=()=>(r.push(Ie(!1)()),e),e.not={assert:(n,o)=>(r.push(N(!0,n,"array",o)),e),empty:()=>(r.push(Ie(!0)()),e),ofExactLength:n=>(r.push(Ue(!0)(n)),e)},e.items=function(n){return te([(o,s="")=>{let a=e(o,s);if(a.hasError)throw a.error;let S=a.result.map((R,M)=>n(R,[s,`[${M}]`].filter(Boolean).join(".")));if(S.some(R=>R.hasError))throw S.filter(R=>R.hasError);return S.reduce((R,M)=>(M.hasError||R.push(M.result),R),[])}])},e}var Ne=Y("boolean"),Be=t=>()=>(r,e="")=>{Ne(e,()=>t?!r:r,r,"true",t)},We=t=>()=>(r,e="")=>{Ne(e,()=>t?r:!r,r,"false",t)};function ue(t=[]){let r=[],e=F(r,t,(o,s="")=>{if(typeof o!="boolean")throw new E(s,`Value ${o} is not a boolean`)});e.toString=P(e,o=>o.toString()),e.toNumber=A(e,o=>o?1:0),e.toBoolean=U(e,o=>o),e.toCustom=_(e),e.toArray=L(e);let n=o=>(s,a)=>(r.push(N(o,s,"boolean",a)),e);return e.assert=n(!1),e.true=()=>(r.push(Be(!1)()),ne(!0,e)),e.false=()=>(r.push(We(!1)()),ne(!1,e)),e.not={assert:n(!0),true:()=>(r.push(Be(!0)()),ne(!1,e)),false:()=>(r.push(We(!0)()),ne(!0,e))},e}function ve(t=[]){let e=F([],t,(n,o="")=>{if(typeof n!="boolean")throw new E(o,`Value ${n} is not a boolean`);if(n!==!1)throw new E(o,`Value ${n} must be false`)});return e.toString=P(e,n=>n.toString()),e.toNumber=A(e,n=>n?1:0),e.toBoolean=U(e,n=>n),e.toCustom=_(e),e.toArray=L(e),e}function Le(t=[]){let e=F([],t,(n,o="")=>{if(typeof n!="boolean")throw new E(o,`Value ${n} is not a boolean`);if(n!==!0)throw new E(o,`Value ${n} must be true`)});return e.toString=P(e,n=>n.toString()),e.toNumber=A(e,n=>n?1:0),e.toBoolean=U(e,n=>n),e.toCustom=_(e),e.toArray=L(e),e}function $e(t=[]){let r=[],e=F(r,t);e.toString=P(e,()=>""),e.toNumber=A(e,()=>0),e.toBoolean=U(e,()=>!1),e.toCustom=_(e),e.toArray=L(e);let n=o=>(s,a)=>(r.push(N(o,s,"custom value",a)),e);return e.assert=n(!1),e.not={assert:n(!0)},e}var Q=Y("number"),je=t=>r=>(e,n="")=>{if(!(t?r.indexOf(e)===-1:r.indexOf(e)!==-1))throw new E(n,`Number value ${e} ${t?`is one of the disallowed values in [${r.join(", ")}]`:`is not one of the allowed values in [${r.join(", ")}]`}`)},Ce=t=>()=>(r,e="")=>{Q(e,()=>t?r<0:r>0,r,"positive",t)},Me=t=>()=>(r,e="")=>{Q(e,()=>t?r>0:r<0,r,"negative",t)},De=t=>()=>(r,e="")=>{Q(e,()=>t?r!==0:r===0,r,"zero",t)},qe=t=>r=>(e,n="")=>{Q(n,()=>t?e>=r:e<r,e,`less than ${r}`,t)},Ve=t=>r=>(e,n="")=>{Q(n,()=>t?e<=r:e>r,e,`more than ${r}`,t)},Ke=t=>r=>(e,n="")=>{Q(n,()=>t?e!==r:e===r,e,`equal to ${r}`,t)},ze=t=>r=>(e,n="")=>{Q(n,()=>t?e%r!==0:e%r===0,e,`a multiple of ${r}`,t)},He=t=>()=>(r,e="")=>{Q(e,()=>t?!Number.isInteger(r):Number.isInteger(r),r,"an integer",t)};function le(t=[]){let r=[],e=F(r,t,(o,s="")=>{if(typeof o!="number")throw new E(s,`Value ${o} is not a number`)});e.toString=P(e,o=>o.toString()),e.toNumber=A(e,o=>o),e.toBoolean=U(e,o=>o!==0),e.toCustom=_(e),e.toArray=L(e);let n=o=>(s,a)=>(r.push(N(o,s,"number",a)),e);return e.assert=n(!1),e.allowed=(...o)=>(r.push(je(!1)(o)),e),e.integer=()=>(r.push(He(!1)()),e),e.positive=()=>(r.push(Ce(!1)()),e),e.negative=()=>(r.push(Me(!1)()),e),e.lessThan=o=>(r.push(qe(!1)(o)),e),e.moreThan=o=>(r.push(Ve(!1)(o)),e),e.zero=()=>(r.push(De(!1)()),e),e.multipleOf=o=>(r.push(ze(!1)(o)),e),e.equals=o=>(r.push(Ke(!1)(o)),e),e.not={assert:n(!0),allowed:(...o)=>(r.push(je(!0)(o)),e),integer:()=>(r.push(He(!0)()),e),positive:()=>(r.push(Ce(!0)()),e),negative:()=>(r.push(Me(!0)()),e),lessThan:o=>(r.push(qe(!0)(o)),e),moreThan:o=>(r.push(Ve(!0)(o)),e),zero:()=>(r.push(De(!0)()),e),multipleOf:o=>(r.push(ze(!0)(o)),e),equals:o=>(r.push(Ke(!0)(o)),e)},e}function ce(t=[]){let r=[],e=F(r,t);e.toCustom=_(e);let n=o=>(s,a)=>(r.push(N(o,s,"custom value",a)),e);return e.assert=n(!1),e.not={assert:n(!0)},e}function P(t,r){return(e=r)=>fe([(n,o="")=>{let s=t(n,o);if(s.hasError)throw s.error;try{return e(s.result)}catch(a){throw new E(o,`Unable to create a string from ${typeof s.result} ${s.result}

 ${a instanceof Error?a.message:a}`)}}])}function A(t,r){return(e=r)=>le([(n,o="")=>{let s=t(n,o);if(s.hasError)throw s.error;try{return e(s.result)}catch(a){throw new E(o,`Unable to create a number from ${typeof s.result} ${s.result}

 ${a instanceof Error?a.message:a}`)}}])}function U(t,r){return(e=r)=>ue([(n,o="")=>{let s=t(n,o);if(s.hasError)throw s.error;try{return e(s.result)}catch(a){throw new E(o,`Unable to create a booolean from ${typeof s.result} ${s.result}

 ${a instanceof Error?a.message:a}`)}}])}function _(t){return r=>$e([(e,n="")=>{let o=t(e,n);if(o.hasError)throw o.error;try{return r(o.result)}catch(s){throw new E(n,`Unable to create custom type from ${typeof o.result} ${o.result}

 ${s instanceof Error?s.message:s}`)}}])}function L(t){return r=>te([(e,n="")=>{let o=t(e,n);if(o.hasError)throw o.error;try{return r(o.result)}catch(s){throw new E(n,`Unable to create an array from ${typeof o.result} ${o.result}

 ${s instanceof Error?s.message:s}`)}}])}function Ee(t){return ce([(r,e="")=>{let n=t(r,e);if(n.hasError)throw n.error;return r}])}function ne(t,r){return(t?Le:ve)([(n,o="")=>{let s=r(n,o);if(s.hasError)throw s.error;return n}])}var Xe=Y("string"),Je=(t,r)=>e=>(n,o="")=>{Xe(o,()=>{let s=r?e:e.toLowerCase(),a=r?n:n.toLowerCase();return t?a!==s:a===s},n,"equal to",t)},Ge=(t,r)=>e=>(n,o="")=>{let s=r?e:e.map(R=>R.toLowerCase()),a=r?n:n.toLowerCase();if(!(t?s.indexOf(a)===-1:s.indexOf(a)!==-1))throw new E(o,`String value ${n} ${t?`is one of the disallowed values in [${e.join(", ")}]`:`is not one of the allowed values in [${e.join(", ")}]`}`)},Ye=t=>()=>(r,e="")=>{Xe(e,()=>t?r.length!==0:r.length===0,r,"empty",t)},Qe=t=>r=>(e,n="")=>{if(!(t?!r.test(e):r.test(e)))throw new E(n,`String value '${e}' ${t?"matches":"does not match"} pattern ${r}`)};function fe(t=[]){let r=[],e={enabled:!0},n=F(r,t,(s,a="")=>{if(typeof s!="string")throw new E(a,`Value ${s} is not a string`)});n.toString=P(n,s=>s),n.toNumber=A(n,s=>Number(s)),n.toBoolean=U(n,s=>!!s),n.toCustom=_(n),n.toArray=L(n);let o=s=>(a,S)=>(r.push(N(s,a,"string",S)),n);return n.assert=o(!1),n.allowed=(...s)=>(r.push(Ge(!1,e.enabled)(s)),Ee(n)),n.matches=s=>(r.push(Qe(!1)(s)),n),n.empty=()=>(r.push(Ye(!1)()),n),n.equals=s=>(r.push(Je(!1,e.enabled)(s)),Ee(n)),n.case=s=>(e.enabled=s==="sensitive",n),n.not={assert:o(!0),allowed:(...s)=>(r.push(Ge(!0,e.enabled)(s)),n),matches:s=>(r.push(Qe(!0)(s)),n),empty:()=>(r.push(Ye(!0)()),n),equals:s=>(r.push(Je(!0,e.enabled)(s)),n)},n}function pe(...t){return(r,e="")=>{let n=[];for(let o of t){let s=o(r,e);if(!s.hasError)return s;n.push(s)}return{hasError:!0,initialValue:r,error:n}}}function me(t=[]){let r=F([],t,(e,n="")=>{if(e!==void 0)throw new E(n,`Value ${e} is not undefined`)});return r.toString=P(r,()=>String(void 0)),r.toNumber=A(r,()=>NaN),r.toBoolean=U(r,()=>!!void 0),r.toCustom=_(r),r.toArray=L(r),r}function ye(...t){return pe(me(),...t)}function ge(t=[]){let r=[],e=F(r,t,(o,s="")=>{if(o===null||typeof o!="object"||Array.isArray(o))throw new E(s,`Value ${o} is not an object`)});e.toString=P(e,o=>String(o)),e.toNumber=A(e,o=>Number(o)),e.toBoolean=U(e,o=>!!o),e.toCustom=_(e);let n=o=>(s,a)=>(r.push(N(o,s,"object",a)),e);return e.assert=n(!1),e.not={assert:n(!0)},e.schema=function(o){return ge([(s,a="")=>{let S=e(s,a);if(S.hasError)throw S.error;let R={...s??{},...S.result},M=Object.entries(o).map(([O,D])=>[O,D(R[O],[a,O].filter(Boolean).join("."))]),re=M.filter(([,O])=>O.hasError);if(re.length>0)throw re.reduce((O,[D,v])=>(O[D]=v,O),{});return M.reduce((O,[D,v])=>(v.hasError||(O[D]=v.result),O),R)}])},e.partial=function(o){return ge([(s,a="")=>{let S=e(s,a);if(S.hasError)throw S.error;let R={...s??{},...S.result},M=Object.entries(o).map(([O,D])=>{let v=ye(D)(R[O],[a,O].filter(Boolean).join("."));return v.hasError&&console.error("ERROR IS HERE",v.error),[O,v]}),re=M.filter(([,O])=>O.hasError);if(re.length>0)throw re.reduce((O,[D,v])=>(O[D]=v,O),{});return M.reduce((O,[D,v])=>(v.hasError||v.result!==void 0&&(O[D]=v.result),O),R)}])},e}function Ze(t=[]){let r=F([],t,(e,n="")=>{if(e!==null)throw new E(n,`Value ${e} is not null`)});return r.toString=P(r,()=>String(null)),r.toNumber=A(r,()=>0),r.toBoolean=U(r,()=>!!null),r.toCustom=_(r),r}function er(){let t=F([],[],(r,e="")=>{if(r!==null)throw new E(e,`Value ${r} is not an error`)});return t.toString=P(t,r=>String(r)),t.toNumber=A(t,()=>0),t.toBoolean=U(t,()=>!!null),t.toCustom=_(t),t}function rr(t){let r=(e,n="")=>{if(!e||typeof e!="object"||Array.isArray(e))return{initialValue:e,hasError:!0,error:new E(n,`Value ${e} is not a record`)};let o=Object.entries(e).map(([s,a],S)=>t(a,[s,`[${S}]`].filter(Boolean).join(".")));return o.some(s=>s.hasError)?{initialValue:e,hasError:!0,error:o.filter(s=>s.hasError)}:{hasError:!1,initialValue:e,result:e}};return r.toString=P(r,e=>String(e)),r.toNumber=A(r,e=>Number(e)),r.toBoolean=U(r,e=>!!e),r.toCustom=_(r),r.toArray=L(r),r}var i={string:fe,number:le,boolean:ue,array:te,object:ge,error:er,null:Ze,undefined:me,oneof:pe,stringUnion:ce,record:rr,optional:ye,anything:()=>t=>({initialValue:t,hasError:!1,result:t})};function j(t){return r=>!t(r).hasError}var Br=i.object().schema({target:i.string().equals("offscreen_manager"),task_id:i.string(),response:i.oneof(i.object().schema({success:i.boolean().true(),value:i.string()}),i.object().schema({success:i.boolean().false(),error:i.anything()}))}),Lu=j(Br);function Se(t,r){return{target:"offscreen_manager",task_id:t,response:r}}var tr=i.object().schema({request:i.string().equals("create_opfs_url"),request_id:i.string(),opfs_location:i.string(),mime_type:i.string()}),nr=i.object().schema({request:i.string().equals("destroy_opfs_url"),request_id:i.string()}),or=i.object().schema({legacy:i.boolean().true(),allowed_time:i.number(),worker_name:i.string(),parameters:i.anything(),binary_location:i.oneof(i.string(),i.null())}),sr=i.object().schema({task_id:i.string(),legacy:i.boolean().false(),allowed_time:i.number(),worker_name:i.string(),binary_location:i.string()}),Wr=i.object().schema({target:i.string().equals("offscreen"),data:i.oneof(tr,nr,or,sr)}),ar=j(Wr),ir=j(tr),ur=j(nr);var lr=j(sr),cr=j(or);function fr(t){return!!(t&&typeof t=="object"&&!Array.isArray(t))}function q(t){return{success:!1,error:t}}function K(t){return{success:!0,value:t}}function X(t){try{let r=t();return pr(r)?r:K(r)}catch(r){return q(r)}}async function C(t){try{let r=await t();return pr(r)?r:K(r)}catch(r){return q(r)}}function pr(t){return fr(t)&&typeof t.success=="boolean"&&(t.success&&"value"in t||!t.success&&"error"in t)}function Re(t){return X(()=>JSON.parse(t))}function mr(t){return X(()=>JSON.stringify(t))}var Z=class extends Error{_error;_type;_state;constructor(r){super(typeof r=="string"?r:void 0),this._error=typeof r=="string"?this:r,this._type=Z.SerializedType}toJSON(){return{__serialized_type:this._type,stack:this._error.stack,message:this._error.message,name:this._error.name,state:this._state}}static create(r){if(r instanceof Error)return new Z(r);if(typeof r=="string"||typeof r=="boolean"||typeof r=="number"||typeof r=="symbol"||typeof r=="bigint"||typeof r=="function")return new Z(r.toString());if(oe(r))return vr(r);let e=mr(r);return e.success?new Z(e.value):new Z("Unserializeable data error")}setState(r){this._state=r}},$=Z;V($,"SerializedType","JSONableError");var Nr=i.object().schema({__serialized_type:i.string().equals($.SerializedType),stack:i.optional(i.string()),message:i.string(),name:i.string(),state:i.anything()}),oe=j(Nr);function vr(t){let r=new Error;return r.stack=t.stack,r.name=t.name,r.message=t.message,new $(r)}var _e=class extends ${constructor(r,e={}){super(`Expected [${r}] response was not valid`),this._type=_e.SerializedType,this.setState({expectedType:r,errors:e})}},de=_e;V(de,"SerializedType","UnexpectedResponseError");var Lr=i.object().schema({__serialized_type:i.string().equals(de.SerializedType),stack:i.optional(i.string()),message:i.string(),name:i.string(),state:i.object().schema({expectedType:i.string(),errors:i.record(i.string())})}),kc=j(Lr);var be=class extends ${};V(be,"SerializedType","TimeSensitiveMessageExpiryError");async function he(t,r=1e3){return await Promise.race([C(typeof t=="function"?t:()=>t),C(()=>new Promise((e,n)=>setTimeout(()=>n(new be(`Message expired after ${r}ms`)),r)))])}function H(...t){}var $r=console,yr=$r;var gr=u!=="all"?u.map(t=>t.split(".")):null,ee=yr;globalThis.console=new Proxy(ee,{get:()=>H});function z(t){return gr&&!jr(t,gr)?{log:H,warn:H,error:(r,...e)=>ee.error(`[${t}] ${r}`,...e),info:H,debug:H}:{log:(r,...e)=>ee.log(`[${t}] ${r}`,...e),warn:(r,...e)=>ee.warn(`[${t}] ${r}`,...e),error:(r,...e)=>ee.error(`[${t}] ${r}`,...e),info:(r,...e)=>ee.info(`[${t}] ${r}`,...e),debug:(r,...e)=>ee.debug(`[${t}] ${r}`,...e)}}function jr(t,r){let e=t.split(".");for(let n of r){let o=0,s=!0;for(;o<e.length;){if(n[o]==="*"){if(n.length-1===o){s=!0;break}o+=1;continue}if(n[o]===e[o]){o+=1;continue}s=!1;break}if(s)return!0}return!1}var dr=z("common.opfs"),we=class extends ${constructor(r){let e=r instanceof Error?r.message:r;super(`Error during OPFS operation: ${e}`),this.setState({originalError:r})}};V(we,"SerializedType","OPFSError");var I=class{static async asFailable(r){let e=await C(r);return e.success?e:q(new we(e.error instanceof Error?e.error:JSON.stringify(e)))}static async _getRootDirectory(){return navigator.storage.getDirectory()}static async _getDirectoryHandle(r){if(!r.endsWith("/")&&r!=="")throw new Error("path should end with / or should be blank for root");r==="/"&&(r="");let e=await I._getRootDirectory(),n=r.split("/"),o=e;for(let s=0;s<n.length-1;s++){let a=await C(()=>o.getDirectoryHandle(n[s],{create:!0}));if(a.success)o=a.value;else throw dr.error(`error getting directory handle for [${n[s]}]`,a.error),new Error(`error getting directory handle for [${n[s]}]`)}return o}static async _getFileHandle(r,e){let n=r.lastIndexOf("/"),o=await I._getDirectoryHandle(r.substring(0,n+1)),s=r.substring(n+1);return await o.getFileHandle(s,e)}static async _getFile(r){return(await this._getFileHandle(r,{create:!1})).getFile()}static async _getFileWriteStream(r,e){return(await this._getFileHandle(r,{create:e?.create??!1})).createWritable({keepExistingData:e?.keepExistingData??!1})}static async _writeFile(r,e,n={keepExistingData:!1}){let o=await I._getFileWriteStream(r,{keepExistingData:n.keepExistingData,create:!0});await o.write(e),await o.close()}static async getFileWriteStream(r,e){return I.asFailable(()=>I._getFileWriteStream(r,e))}static async writeFile(r,e,n){return I.asFailable(()=>I._writeFile(r,e,n))}static async getFileReadStream(r){return I.asFailable(async()=>(await I._getFile(r)).stream())}static async getFile(r){return I.asFailable(()=>I._getFile(r))}static async readAllFileBytes(r){return I.asFailable(async()=>{let e=(await I._getFile(r)).stream(),n=new Response(e);return new Uint8Array(await n.arrayBuffer())})}static async destroyFileInDir(r,e){return I.asFailable(async()=>await e.removeEntry(r,{recursive:!0}))}static async destroyFile(r){return I.asFailable(async()=>{let e=r.lastIndexOf("/"),n=await I._getDirectoryHandle(r.substring(0,e+1)),o=r.substring(e+1);return await n.removeEntry(o,{recursive:!0})})}static async _listFiles(r){let e=r.values(),n=[];for await(let o of e){let s=o;s.kind==="directory"?n.push(...await this._listFiles(s)):n.push({dirHandle:r,fileName:s.name})}return n}static async listFiles(r){let e=await C(()=>this._getDirectoryHandle(r));return e.success?this._listFiles(e.value):(dr.error("error getting handle",e.error),[])}},J=I;V(J,"isSupported",()=>typeof navigator.storage?.getDirectory=="function");var Oe=z("offscreen.handlers.object_urls"),ke=new Map;function br(t){return Cr(t.request_id)}async function hr(t){let r=await J.readAllFileBytes(t.opfs_location);if(!r.success)return Oe.error("Unable to read file from OPFS",t.opfs_location,r.error),r;Oe.info;let e=new Blob([r.value],{type:t.mime_type});return Mr(t.request_id,e)}function Cr(t){return X(()=>{let r=ke.get(t);r&&(URL.revokeObjectURL(r),ke.delete(t))})}function Mr(t,r){return X(()=>{let e=ke.get(t);e&&(Oe.warn("Request ID collision",t,e),X(()=>URL.revokeObjectURL(e)));let n=URL.createObjectURL(r);return ke.set(t,n),n})}var xe=class{_resolver=H;_rejecter=H;_promise;_settled=!1;get[Symbol.toStringTag](){return"[object SynchronizingPromise]"}constructor(){this._promise=new Promise((r,e)=>{this._resolver=n=>{this._settled=!0,r(n)},this._rejecter=n=>{this._settled=!0,e(n)}})}get isSettled(){return this._settled}get reject(){return this._rejecter}get resolve(){return this._resolver}then(r,e){return this._promise.then(r,e)}catch(r){return this._promise.catch(r)}finally(r){return this._promise.finally(r)}};async function wr(t){return C(async()=>{let r=t.binary_location,e=r?await J.readAllFileBytes(r):null;if(!e?.success)throw new Error(`Failed to lookup binary data in OPFS at [${r}]`);let n=e&&e.success?new Uint8Array(e.value):null,o=new Worker(G.runtime.getURL(`${t.worker_name}.worker.js`)),s=await he(async()=>{await new Promise(S=>{let R=M=>{M.data==="ready"&&(o.removeEventListener("message",R),S(void 0))};o.addEventListener("message",R)});let a=new xe;return o.addEventListener("message",S=>{try{let R=JSON.parse(S.data);oe(R)?a.reject(R):a.resolve(R)}catch{a.resolve(S.data)}}),n?o.postMessage({bytes:n,parameters:t.parameters},[n.buffer]):o.postMessage({bytes:null,parameters:t.parameters}),a},t.allowed_time);return o.terminate(),s})}var Dr=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Fe={randomUUID:Dr};var Te,qr=new Uint8Array(16);function Pe(){if(!Te&&(Te=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Te))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Te(qr)}var W=[];for(let t=0;t<256;++t)W.push((t+256).toString(16).slice(1));function kr(t,r=0){return(W[t[r+0]]+W[t[r+1]]+W[t[r+2]]+W[t[r+3]]+"-"+W[t[r+4]]+W[t[r+5]]+"-"+W[t[r+6]]+W[t[r+7]]+"-"+W[t[r+8]]+W[t[r+9]]+"-"+W[t[r+10]]+W[t[r+11]]+W[t[r+12]]+W[t[r+13]]+W[t[r+14]]+W[t[r+15]]).toLowerCase()}function Vr(){if(Fe.randomUUID)return Fe.randomUUID();let t=Pe();return t[6]=t[6]&15|64,t[8]=t[8]&63|128,kr(t)}var xr=Vr;var se=xr;var Yd=z("offscreen.response_packer");var zr=i.object().schema({keepalive:i.oneof(i.number(),i.boolean().false()),maxConcurrency:i.oneof(i.string().equals("max"),i.number())}),Hr=i.object().schema({ready:i.boolean().true(),poolSettings:zr}),Tr=j(Hr),Tb=z("offscreen.initialize_worker");var B=z("offscreen.handlers.worker_execution"),Er=new class{_pools=new Map;get maxConcurrency(){return navigator.hardwareConcurrency}handleExecutionRequest=async r=>{let e=this._pools.get(r.worker_name);return e?(B.warn("INCOMING CURRENT POOL",r.task_id,e.workers),await this.queueRequest(r,e),K(void 0)):(B.warn("INCOMING INITIALIZING POOL",r.task_id),this.spawnWorkerPool(r))};createDummyWorker=()=>({id:se(),isInitialized:!1,isWorking:!1});spawnWorkerPool=async r=>{let e=this.createDummyWorker(),n={settings:{keepalive:1e3,maxConcurrency:1},workers:[e],queue:[],requests:new Map},o=await this.spawnWorker(r.worker_name);if(!o.success)return o;let s=n.workers.indexOf(e);return n.workers.splice(s,1,o.value.worker),n.settings=o.value.poolSettings,this._pools.set(r.worker_name,n),await this.queueRequest(r,n),K(void 0)};spawnWorkerInExistingPool=async(r,e)=>{let n=this.createDummyWorker();e.workers.push(n);let o=await this.spawnWorker(r),s=e.workers.indexOf(n);if(o.success)e.workers.splice(s,1,o.value.worker);else return e.workers.splice(s,1),o;return K(o.value.worker)};spawnWorker=async r=>{let e=new Worker(G.runtime.getURL(`${r}.worker.js`));e.isWorking=!1,e.isInitialized=!1,e.id=se();let n=await he(()=>new Promise(o=>{let s=a=>{Tr(a.data)?(B.warn("Ready received from worker",e),e.removeEventListener("message",s),e.isInitialized=!0,o(a.data.poolSettings)):B.warn("Received unknown init message",a.data)};e.addEventListener("message",s)}),2e3);return n.success?(B.warn("SPAWNED WORKER",e.id),e.startWorking=()=>{e._timeout&&clearTimeout(e._timeout),e.isWorking=!0},e.destroy=()=>{let o=this._pools.get(r);o&&(o.workers=o.workers.filter(s=>s!==e),B.info("RESET WORKERS",o.workers)),B.warn("TERMINATION",e),e.terminate()},e.stopWorking=()=>{B.warn("STOP WORKING",e);let o=typeof n.value.keepalive=="boolean"?0:n.value.keepalive;o?(B.warn("TIMEOUT DESTROY",o,e),e._timeout=self.setTimeout(()=>e.destroy(),o)):(B.warn("DIRECT DESTROY",e),e.destroy()),e.isWorking=!1},K({worker:e,poolSettings:n.value})):(e.terminate(),n)};sendRequestToWorker=(r,e)=>{e.startWorking();let n=async a=>{let S=await C(()=>G.runtime.sendMessage(Se(r.task_id,a)));S.success||B.warn("Failed to send worker response message to offscreen",S.error,a)},o=a=>{e.removeEventListener("error",s),e.removeEventListener("message",o);let S=Re(a.data);S.success?oe(S.value)?n(q(S.value)):typeof S.value=="string"?n(K(S.value)):(B.warn("Received an unexpected response from worker",S.value),n(q(new Error("Unexpected result from worker")))):n(q(new $(S.error instanceof Error?S.error:String(S.error)))),self.queueMicrotask(()=>this.pickNextFromQueue(e,r.worker_name))},s=a=>{e.removeEventListener("error",s),e.removeEventListener("message",o),e.destroy(),G.runtime.sendMessage(Se(r.task_id,q(a.error)))};e.addEventListener("error",s),e.addEventListener("message",o);try{e.postMessage({binary_location:r.binary_location,task_id:r.task_id})}catch(a){B.warn("Exception handling message",a)}};pickNextFromQueue=(r,e)=>{let n=this._pools.get(e);if(!n){B.error(`Missing expected pool [${e}] with worker`,r);return}let o=n.queue.shift();if(!o){r.stopWorking();return}this.sendRequestToWorker(o,r)};queueRequest=async(r,e)=>{let n=e.workers.find(s=>s.isInitialized&&!s.isWorking);if(n)return B.warn("FREE WORKER AVAILABLE",n.id,r),this.sendRequestToWorker(r,n);let o=e.settings.maxConcurrency==="max"?navigator.hardwareConcurrency:e.settings.maxConcurrency;if(e.workers.length<o){B.warn("CONCURRENCY AVAILABLE",r);let s=await this.spawnWorkerInExistingPool(r.worker_name,e);if(s.success)return this.sendRequestToWorker(r,s.value);B.error("FAILED WORKER SPAWNING",r)}e.queue.push(r),B.error("QUEING REQUEST",r,e.queue)}};G.runtime.onMessage.addListener((t,r,e)=>{if(ar(t))return Jr(t).then(n=>{e(n)}),!0});async function Jr(t){let r=t.data;if(ir(r))return hr(r);if(ur(r))return br(r);if(lr(r))return Er.handleExecutionRequest(r);if(cr(r))return wr(r)}})();
